@model DH.Helpdesk.Web.Models.Case.CaseInputViewModel
@using System.Web.Optimization
@using DH.Helpdesk.Web

@{ var t = new ViewDataDictionary();
   t.Add("isJS", "true");
}

@if (Model.DynamicCase != null && Model.DynamicCase.ExternalPage)
{
    @Styles.Render("~/cases/dynamic-cases")
}

@Scripts.Render("~/bundles/cases/edit")

@section Scripts {
    <script type="text/javascript">
        
        $(document).ready(function () {

            CaseInitForm();

            var dc = function(text) {
                return $("<div>" + text + "<div>");
            };

            var confirmDialog = function(d, onOk, onCancel) {
                return d.dialog({
                    title: '@Translation.Get("Meddelande")',
                    buttons: [
                        {
                            text: '@Translation.Get("OK")',
                            click: function() {
                                onOk();
                                d.dialog("close");
                            }
                        },
                        {
                            text: '@Translation.Get("Avbryt")',
                            click: function() {
                                onCancel();
                                d.dialog("close");
                            }
                        }
                    ],
                    modal: true
                });
            };

            var messageDialog= function(d) {
                return d.dialog({
                    title: '@Translation.Get("Meddelande")',
                    buttons: [
                        {
                            text: '@Translation.Get("Stäng")',
                            click: function() {
                                d.dialog("close");
                            }
                        }
                    ],
                    modal: true
                });
            };

        

            var emptyFn = function() {};

            $("#case-action-save").click(function (e) {
               e.preventDefault();
               $('#case__StateSecondary_Id').removeAttr('disabled');
            });

            $("#case-action-save-and-close").click(function (e) {
                e.preventDefault();
                $('#case__StateSecondary_Id').removeAttr('disabled');
            });

            $("#case-action-save-and-new").click(function (e) {
                e.preventDefault();
                $('#case__StateSecondary_Id').removeAttr('disabled');
            });
                      
            $("#case-action-close").click(function (e) {
                e.preventDefault();
                var targetUrl = $(this).attr("href");
                if ('@Model.CaseLock.LockGUID' != '')
                    UnLockCase('@Model.CaseLock.LockGUID', targetUrl);               
            });
            
             @*$("#case-action-delete").click(function (e) {                               
                if (hasNotInvoicedArticles()) {
                    messageDialog(dc('@Translation.Get("Du får inte ta bort ett ärende som har invalda men ofakturerade artiklar.")'));
                    return false;
                }
                return true;                       
            })*@
        });                
     
        function redirectToUrl(url) {            
            window.location.href = url;
        }

        function MakeAsUnread() {             
            $.post('@Url.Content("~/Cases/IsCaseAvailable/")',
                {
                    caseId: '@Model.CaseLock.CaseId',
                    caseChangedTime: '@Model.case_.ChangeTime',
                    lockGuid: '@Model.CaseLock.LockGUID'
                },
                function (data) {
                    if (data == true) {
                        $.post('/cases/markasunread/', { id: '@Model.case_.Id', customerId: '@Model.case_.Customer_Id' }, function (data) {
                            if (data == "Success") {
                                $('#case__Unread').val(1);
                                ShowToastMessage('@Translation.Get("Ärendet har markerats som oläst")', "notice");
                            }
                        });
                    }
                    else {
                        ShowToastMessage('@Translation.Get("Ärendet kan inte ändras då det är öppet hos en annan användare.")', "error", false);                        
                    }
                });            
        };
        
        function UnLockCase(lockGuid, url) {
            $.post('@Url.Content("~/Cases/UnLockCase/")', { lockGUID: lockGuid }, function (data) {                
                if (data != "Success")
                {                    
                    ShowToastMessage('@Translation.Get("Ett fel inträffade när ärendet skulle låsas upp automatiskt. Var vänlig kontakta systemadministratören.")', "Error");
                }
                if (url) {                    
                    redirectToUrl(url);
                }
            });
        };
                
        //HIDE SHOW
        $( ".hidebtn" ).on( "click", function() {
            $( this ).parents( ".notifier-block" ).addClass( "hideshow" );
        });
        $( ".showbtn" ).on( "click", function() {
            $( this ).parents( ".notifier-block" ).removeClass( "hideshow" );
        });
        $(".hidebtn").on("click", function () {
            $(this).parents(".regarding-block").addClass("hideshowregarding");
        });
        $(".showbtn").on("click", function () {
            $(this).parents(".regarding-block").removeClass("hideshowregarding");
        });
        $( ".hidebtn" ).on( "click", function() {
            $( this ).parents( ".computer-block" ).addClass( "hideshow" );
        });
        $( ".showbtn" ).on( "click", function() {
            $(this).parents(".computer-block").removeClass("hideshow");
        });

        $( ".hidebtn" ).on( "click", function() {
            $( this ).parents( ".caseinfo-block" ).addClass( "hideshow" );
        });
        $( ".showbtn" ).on( "click", function() {
            $( this ).parents( ".caseinfo-block" ).removeClass( "hideshow" );
        });

        $( ".hidebtn" ).on( "click", function() {
            $( this ).parents( ".casehandling-block" ).addClass( "hideshow" );
        });
        $( ".showbtn" ).on( "click", function() {
            $( this ).parents( ".casehandling-block" ).removeClass( "hideshow" );
        });
    </script>
}

@if (Model.DynamicCase != null && Model.DynamicCase.ExternalPage)
{
    @System.Web.Optimization.Scripts.Render(BundleConfig.ScriptNames.DynamicCase)

    <script type="text/javascript">
        $(function () {
            @{
  
    string formUrl = string.Empty;

    UriBuilder uriBuilder = new UriBuilder();
    var queryString = (Model.DynamicCase.FormPath.Contains("?") ? Model.DynamicCase.FormPath.Substring(Model.DynamicCase.FormPath.IndexOf("?")) : "");


    //Build URL
    if (Model.DynamicCase.ExternalSite)
    {

        uriBuilder.Scheme = Model.DynamicCase.Scheme;
        uriBuilder.Host = Model.DynamicCase.Host;

        if (!string.IsNullOrEmpty(queryString))
        {
            uriBuilder.Path = Model.DynamicCase.FormPath.ToLower().Replace(queryString.ToLower(), "");
            uriBuilder.Query = (queryString.StartsWith("?") ? queryString.Remove(0, 1) : queryString);
        }
        else
        {
            uriBuilder.Path = Model.DynamicCase.FormPath;
        }

        Uri uri = uriBuilder.Uri;

        formUrl = uri.ToString();

    }
    //Sub Site
    else
    {
        if (!string.IsNullOrEmpty(queryString))
        {
            uriBuilder.Path = Path.Combine(Model.DynamicCase.Host, Model.DynamicCase.FormPath.ToLower().Replace(queryString.ToLower(), ""));
            uriBuilder.Query = (queryString.StartsWith("?") ? queryString.Remove(0, 1) : queryString);
        }
        else
        {
            uriBuilder.Path = Path.Combine(Model.DynamicCase.Host, Model.DynamicCase.FormPath);
        }

        Uri uri = uriBuilder.Uri;

        formUrl = (uri.AbsolutePath.EndsWith("/") ? uri.AbsolutePath.Remove(uri.AbsolutePath.LastIndexOf("/"), 1) : "") + uri.Query;

    }
            }

            var urlToSend = '@formUrl'.replace(/\\/g, '&#92;');
            var currentpage = new dhform({ url: urlToSend, modal: '@Model.DynamicCase.ViewMode' });
        });
    </script>
}

@Html.Partial("_Plupload")

@if (Html.MasterModel() != null && SessionFacade.CurrentUser != null && Model != null)
{
    using (Html.BeginForm("edit", "cases", null, FormMethod.Post, new { id = "target" }))
    {    
        @Html.HiddenFor(m => m.BackUrl) 
    <div class="secnavs fixed">
        <div class="pull-left">
            <ul class="secnav">
                @if (Model.EditMode == Enums.AccessMode.FullAccess)
                {
                    <li>@Html.ActionLink(Translation.Get("Spara", Enums.TranslationSource.TextTranslation), null, null, null, new { @class = "btn save", id = "case-action-save" })</li>
                    <li>@Html.ActionLink(Translation.Get("Spara och stäng", Enums.TranslationSource.TextTranslation), null, null, new { @class = "btn save-close", id = "case-action-save-and-close" })</li>                    
                    <li>@Html.ActionLink(Translation.Get("Spara", Enums.TranslationSource.TextTranslation) + "/" + Translation.Get("Nytt ärende", Enums.TranslationSource.TextTranslation), null, null, new { @class = "btn save-new", id = "case-action-save-and-new" })</li>
                    <li class="secspace"></li>                    
                    if (SessionFacade.CurrentUser.DeleteCasePermission == 1)
                    {                            
                    <li>@Html.ActionLink(Translation.Get("Ta bort", Enums.TranslationSource.TextTranslation), "DeleteCase",
                                new { caseId = @Model.case_.Id, customerId = @Model.case_.Customer_Id }, new
                                {
                                    @class = "btn caseDeleteDialog",
                                    id = "case-action-delete",
                                    deleteDialogText = Translation.Get("Är du säker på att du vill radera detta ärende", Enums.TranslationSource.TextTranslation) + '?'
                                })</li>
                    }
                }
                @if (string.IsNullOrEmpty(Model.BackUrl))
                {
                    <li>@Html.ActionLink(Translation.Get("Stäng", Enums.TranslationSource.TextTranslation), "Index", new { customerId = @Model.case_.Customer_Id }, new { @class = "btn", id = "case-action-close" })</li>
                }
                else
                {                   
                    <li><a id="case-action-close" class = "btn" href="@Model.BackUrl">@Translation.Get("Stäng")</a></li>
                }

                @if (Model.EditMode == Enums.AccessMode.FullAccess)
                {
                    <li>
                        <div id="divActionMenu" class="btn-group">
                            <button class="btn dropdown-toggle" data-toggle="dropdown" id="btnActionMenu">
                                @Translation.Get("Åtgärder", Enums.TranslationSource.TextTranslation)
                                <span class="caret">&nbsp;</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="#" onclick="MakeAsUnread();">
                                        @Translation.Get("Markera ärendet som oläst", Enums.TranslationSource.TextTranslation)
                                    </a>
                                </li>
                                @if (!Model.IsItChildCase() && SessionFacade.CurrentUser.CreateSubCasePermission == 1)
                                {
                                    <li>@Html.ActionLink(Translation.Get("Skapa underärende"), "NewChildCase", new { parentCaseId = Model.case_.Id})</li>
                                }
                                @if (SessionFacade.CurrentUser.ActivateCasePermission == 1 && Model.case_.FinishingDate.HasValue
                                    && (!Model.IsItChildCase() || (Model.IsItChildCase() && !Model.ParentCaseInfo.IsCaseClosed)))
                                {   
                                    <li>@Html.ActionLink(Translation.Get("Aktivera"), "Activate", "Cases", new { id = Model.case_.Id, backUrl = Model.BackUrl }, new { @class="btn" })</li>                             
                                }

                                @if (SessionFacade.CurrentUser.MoveCasePermission == 1)
                                {                                
                                    <li><a data-toggle="modal" href="#divMoveCase">@Translation.Get("Flytta", Enums.TranslationSource.TextTranslation)</a></li>                                    
                                }
                                @if (SessionFacade.CurrentUser.CopyCasePermission == 1)
                                {     
                                    <li><a data-toggle="modal" href="#divCopyCase">@Translation.Get("Kopiera", Enums.TranslationSource.TextTranslation)</a></li>
                                }

                                @if (SessionFacade.CurrentUser.FollowUpPermission == 1)
                                {
                                    if (Model.case_.FollowUpDate.HasValue)
                                    {
                                    <li><a href="/cases/followupRemove/@Model.case_.Id" >@Translation.Get("Ta bort uppföljning", Enums.TranslationSource.TextTranslation)</a></li>
                                    }
                                    else
                                    {
                                    <li><a href="/cases/followup/@Model.case_.Id" >@Translation.Get("Följ upp", Enums.TranslationSource.TextTranslation)</a></li>
                                    }
                                }

                                @if (Model.Languages != null && Model.Languages.Where(l => l.IsActive).ToList().Count > 1)
                                {
                                    var curLanguage = (Model.case_.Id == 0 ? SessionFacade.CurrentLanguageId : Model.case_.RegLanguage_Id);                               
                                    <li class="dropdown-submenu">
                                        <a href="#">
                                            @Translation.Get("Språk för E-mail")
                                        </a>
                                        <ul class="dropdown-menu">
                                            @foreach (var lang in Model.Languages.Where(l => l.IsActive).ToList())
                                            {
                                                var langNameId = "langItem" + lang.Id;
                                                <li>

                                                    <a id="@langNameId" class="langItem" href="#" onclick="ChangeCaseLanguageTo(@lang.Id,true);">@Translation.Get(lang.Name)
                                                        @if (lang.Id == curLanguage)
                                                        {
                                                            <i class='icon-ok'></i>
                                                        }
                                                    </a>                                                  
                                                </li>
                                            }
                                        </ul>
                                    </li>                                    
                                }                                
                            </ul>
                        </div>
                    </li>
                    
                    <li id="btnCaseTemplate">
                        @Html.Partial("_CaseTemplateTree", Model.CaseTemplateTreeButton, t)
                    </li>

                }
                else
                {

                    if (SessionFacade.CurrentUser.ActivateCasePermission == 1 && Model.case_.FinishingDate.HasValue
                        && (!Model.IsItChildCase() || (Model.IsItChildCase() && !Model.ParentCaseInfo.IsCaseClosed)))
                    {                                
                        <li>@Html.ActionLink(Translation.Get("Aktivera"), "Activate", "Cases", new { id = Model.case_.Id, backUrl = Model.BackUrl }, new { @class="btn" })</li>                             
                    }

                }
            </ul>
        </div>
        <div class="pull-right">
            <ul class="secnav">
                @if(Model.case_.Id > 0)
                {
                   <li><a title="@Translation.Get("Skriv ut")" class="btn print-case"><i class="icon-file"></i></a></li>
                }
                
                @if (Html.MasterModel().CustomerSetting.ModuleInventory > 0)
                {                                                            
                    <li><a href="#" title="@Translation.Get("Visa inventarie", Enums.TranslationSource.TextTranslation)" class="btn show-inventory"><i class="icon-th-large"></i></a></li>
                }
                <li><a onclick="UnLockCase('@Model.CaseLock.LockGUID')" href="@Model.case_.Id.GetUrlForNavigationBetweenCases()" title="@Translation.Get("Föregående ärende", Enums.TranslationSource.TextTranslation)" class="btn previous-case"><i class="icon-chevron-left"></i></a></li>
                <li><a onclick="UnLockCase('@Model.CaseLock.LockGUID')" href="@Model.case_.Id.GetUrlForNavigationBetweenCases(true)"  title="@Translation.Get("Nästa ärende", Enums.TranslationSource.TextTranslation)" class="btn next-case"><i class="icon-chevron-right"></i></a></li>
            </ul>
        </div>
    </div>
    
    <div class="editmode">
        @Html.Partial("_Input", Model)
    </div>
    }
    <div id="divMoveCase" role="dialog" class="modal hide fade" aria-labelledby="myModalLabel" aria-hidden="true">
        @Html.Partial("_MoveCase", Model)
    </div>    
    <div id="divCopyCase" role="dialog" class="modal hide fade" aria-labelledby="myModalLabel" aria-hidden="true">
        @Html.Partial("_CopyCase", Model)
    </div>    
}