@model DH.Helpdesk.Web.Models.Case.CaseInputViewModel 
@using DH.Helpdesk.BusinessData.OldComponents
@using DH.Helpdesk.Web.Infrastructure.Extensions.HtmlHelperExtensions

@if (Model != null && Model.Logs != null)
{
    var userTimeZone = TimeZoneInfo.FindSystemTimeZoneById(SessionFacade.CurrentUser.TimeZoneId);
    <div class="tab-pane tab-pane-border active" id="logtab">
        <table class="table table-striped table-bordered table-hover caselog">
            @if (Model.Logs.Any())
            {            
                <thead>
                    <tr>
                        <th>@Translation.Get("Datum",SessionFacade.CurrentCaseLanguageId, Enums.TranslationSource.TextTranslation)</th>
                        <th>@Translation.Get("Registrerad av",SessionFacade.CurrentCaseLanguageId, Enums.TranslationSource.TextTranslation)</th>
                        <th>@Translation.Get(GlobalEnums.TranslationCaseFields.tblLog_Text_External.ToString(),SessionFacade.CurrentCaseLanguageId, Enums.TranslationSource.CaseTranslation, Model.case_.Customer_Id) </th>
                        <th>@Translation.Get(GlobalEnums.TranslationCaseFields.tblLog_Text_Internal.ToString(),SessionFacade.CurrentCaseLanguageId, Enums.TranslationSource.CaseTranslation, Model.case_.Customer_Id) </th>
                        <th>@Translation.Get("E-post",SessionFacade.CurrentCaseLanguageId, Enums.TranslationSource.TextTranslation)</th>
                        <th>@Translation.Get("Filer",SessionFacade.CurrentCaseLanguageId, Enums.TranslationSource.TextTranslation)</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var r in Model.Logs)
                {
                    <tr>
                        <td>
                            @if (r.FinishingDate.HasValue)
                            {
                                <span class="case-icon solved" title="@Translation.GetCoreTextTranslation("Stängt")"></span>
                            }
                            else
                            {
                                <span class="case-icon"></span>
                            }
                            @{
                                r.LogDate = TimeZoneInfo.ConvertTimeFromUtc(r.LogDate.ToUniversalTime(), userTimeZone);
                            }
                            <a href="@GetLogLink(r)">@Html.DisplayFor(m => r.LogDate, "DateAndTime") </a>
                        </td>
                        <td>
                            <a href="@GetLogLink(r)">@(r.User == null ? r.RegUser : Html.FormatUserName(r.User, Model.Setting))</a>
                        </td>
                        <td>
                            <a href="@GetLogLink(r)"> @Html.AttributeEncode(r.TextExternal).ForHtmlView()</a>
                        </td>
                        <td>
                            <a href="@GetLogLink(r)"> @Html.AttributeEncode(r.TextInternal).ForHtmlView()</a>
                        </td>
                        <td>
                            @if (r.CaseHistory != null)
                            {
                                if (r.CaseHistory.Emaillogs != null)
                                {                                        
                                    foreach (var l in r.CaseHistory.Emaillogs)      
                                    {                                            
                                    <div>
                                        <p>
                                            @l.EmailAddress 
                                        </p>
                                    </div>
                                    }                                    
                                }                                        
                            }

                            @if (Model.case_.Mail2Tickets != null)
                            {
                                var countTO = 0;
                                var countCC = 0;
                                var countBCC = 0;
                                var mailTO = "";
                                var mailCC = "";
                                var mailBCC = "";
                                var boldTO = false;
                                var boldCC = false;
                                var boldBCC = false;
                                var show = false;
                                foreach (var mail in Model.case_.Mail2Tickets)
                                {
                                    if (mail.Log_Id != null)
                                    {
                                        if (mail.Type == "to")
                                        {
                                            countTO = countTO + 1;
                                            mailTO = mailTO + mail.EMailAddress + " ";

                                            if (mail.EMailAddress == Model.case_.Customer.HelpdeskEmail)
                                            {
                                                boldTO = true;
                                            }
                                        }

                                        if (mail.Type == "cc")
                                        {
                                            countCC = countCC + 1;
                                            mailCC = mailCC + mail.EMailAddress + " ";

                                            if (mail.EMailAddress == Model.case_.Customer.HelpdeskEmail)
                                            {
                                                boldCC = true;
                                            }
                                        }

                                        if (mail.Type == "bcc")
                                        {
                                            countBCC = countBCC + 1;
                                            mailBCC = mailBCC + mail.EMailAddress + " ";

                                            if (mail.EMailAddress == Model.case_.Customer.HelpdeskEmail)
                                            {
                                                boldBCC = true;
                                            }
                                        }
                                        show = true;
                                    }
                                }
                                if (show)
                                {
                                    <div>
                                        <input type="hidden" id="lastMailSelected" value="">
                                        @if (boldTO == true)
                                        {
                                            <p>
                                                <b>TO[@countTO]</b>&nbsp;&nbsp;&nbsp;<span class="icon-info-sign ml15 expander" rel="tooltip" title="" data-original-title="@mailTO" data-expand-element="mailto"></span>
                                            </p>
                                        }
                                        else
                                        {
                                            <p>
                                                TO[@countTO]&nbsp;&nbsp;&nbsp;<span class="icon-info-sign ml15 expander" rel="tooltip" title="" data-original-title="@mailTO" data-expand-element="mailto"></span>
                                            </p>
                                        }
                                    </div>
                                    <div>
                                        <p id="mailto" class="" style="display:none">@mailTO</p>
                                    </div>
                                    <div>
                                        @if (boldCC == true)
                                        {
                                            <p>
                                                <b>CC[@countCC]</b>&nbsp;&nbsp;&nbsp;<span class="icon-info-sign ml15 expander" rel="tooltip" title="" data-original-title="@mailCC" data-expand-element="mailcc"></span>
                                            </p>
                                        }
                                        else
                                        {
                                            <p>
                                                CC[@countCC]&nbsp;&nbsp;&nbsp;<span class="icon-info-sign ml15 expander" rel="tooltip" title="" data-original-title="@mailCC" data-expand-element="mailcc"></span>
                                            </p>
                                        }
                                    </div>
                                    <div>
                                        <p id="mailcc" class="" style="display:none">@mailCC</p>
                                    </div>
                                    <div>
                                        @if (boldBCC == true)
                                        {
                                            <p>
                                                <b>BCC[@countBCC]</b>&nbsp;<span class="icon-info-sign ml15" rel="tooltip expander" title="" data-original-title="@mailBCC" data-expand-element="mailbcc"></span>
                                            </p>
                                        }
                                        else
                                        {
                                            <p>
                                                BCC[@countBCC]&nbsp;<span class="icon-info-sign ml15" rel="tooltip expander" title="" data-original-title="@mailBCC" data-expand-element="mailbcc"></span>
                                            </p>
                                        }
                                    </div>
                                    <div>
                                        <p id="mailbcc" class="" style="display:none">@mailBCC</p>
                                    </div>
                                }
                            }
                        </td>
                        <td>
                            @if (r.LogFiles != null)
                            {
                                foreach (var l in r.LogFiles)      
                                {                                            
                                <div>
                                    <p>
                                        @if(Model.CaseFilesModel.VirtualDirectory)
                                        {
                                            <a target="_blank" href="@Html.Action("LogFileLinkVD","Files", new { id = r.Id, fileName = l.FileName })">@l.FileName</a>    
                                        }
                                        else{
                                            <a href="@Url.Action("DownloadLogFile", new { id = r.Id, fileName = l.FileName })">@l.FileName</a>    
                                        }
                                    </p>
                                </div>
                                }                                    
                            }
                        </td>
                    </tr>
                }
                </tbody>
            }                
        </table>
    </div>
}

@functions 
{

    private string GetLogLink(DH.Helpdesk.BusinessData.Models.Logs.Output.LogOverview log)
    {
        if (log.ProblemId.HasValue)
        {
            return Url.Action("Problem", "Problems", new { id = log.ProblemId.Value });
        }
        return Url.Action("editlog", "cases", new { area = "", id = log.Id, customerId = Model.case_.Customer_Id });
    }

}