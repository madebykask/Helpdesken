@model DH.Helpdesk.Web.Models.Case.CaseInputViewModel 
@using DH.Helpdesk.Web.Infrastructure.Extensions

@if (Model != null && Model.case_.CaseHistories != null)
{
    var userTimeZone = TimeZoneInfo.FindSystemTimeZoneById(SessionFacade.CurrentUser.TimeZoneId);
    <div class="tab-pane tab-pane-border" id="historytab">
        <table class="table table-striped table-bordered table-hover">
            @if (Model.case_.CaseHistories.Any())
            {            
                <thead>
                    <tr>
                        <th>@Translation.Get("Datum", Enums.TranslationSource.TextTranslation)</th>
                        <th>@Translation.Get("Registrerad av", Enums.TranslationSource.TextTranslation)</th>
                        <th>@Translation.Get("Historik", Enums.TranslationSource.TextTranslation)</th>
                        <th>@Translation.Get("E-post", Enums.TranslationSource.TextTranslation)</th>
                    </tr>
                </thead>
                <tbody>
                @{
                    var histories = Model.case_.CaseHistories.OrderByDescending(x => x.Id).ToArray();
                 }
                    @for(var i = 0; i < histories.Length; i++)
                    {
                        var current = histories[i];     
                        var previous = i < histories.Length - 1 ? histories[i + 1] : null;         
                        <tr>
                            <td style="width:15%">
                                @{
                                    current.CreatedDate = TimeZoneInfo.ConvertTimeFromUtc(current.CreatedDate, userTimeZone);
                                }
                                @Html.DisplayFor(m => current.CreatedDate, "DateAndTime") 
                            </td>
                            <td style="width:15%">
                                @current.CreatedByUser
                            </td>
                            <td style="width:45%">
                                <table class="tableintable">
                                    @current.GetCaseHistoryInfo(previous, Model.case_.Customer_Id, Model.DepartmentFilterFormat, Model.caseFieldSettings)
                                </table>
                            </td>
                            <td style="width:25%">
                                @if (current.Emaillogs != null) 
                                {
                                    <div>
                                        @foreach (var l in current.Emaillogs)
                                        {    
                                            <p>
                                                @l.EmailAddress (@l.MailId.GetMailTemplateName()) 
                                            </p>
                                        }
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            }
        </table>
    </div>
}